<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CII Calculator Dashboard</title>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <!-- PDF report (client-side) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1020;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --border:rgba(255,255,255,.10);
      --shadow:0 16px 40px rgba(0,0,0,.35);
      --radius:18px;
      --good:#2bd576;
      --good2:#62e6b6;
      --warn:#ffcc00;
      --bad2:#ff7a57;
      --bad:#ff5c7a;
      --accent: rgba(124,92,255,.95);
      --accent2: rgba(124,92,255,.55);
      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.03);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(124,92,255,.25), transparent 60%),
        radial-gradient(900px 500px at 80% 20%, rgba(43,213,118,.18), transparent 55%),
        radial-gradient(1200px 700px at 50% 90%, rgba(255,92,122,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      line-height:1.35;
    }

    header{
      padding:18px 20px 10px;
      max-width:1280px;
      margin:0 auto;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
    }
    h1{ margin:0; font-size:22px; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:12px; margin-top:6px; }

    .pillrow{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
    .pill{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      backdrop-filter:blur(10px);
      white-space:nowrap;
    }
    .pill strong{ color:var(--text); font-weight:650; }

    main{
      max-width:1280px;
      margin:0 auto;
      padding:10px 20px 26px;
      display:grid;
      grid-template-columns:420px 1fr;
      gap:16px;
    }

    .card{
      border:1px solid var(--border);
      background:linear-gradient(180deg, var(--glass), var(--glass2));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter:blur(12px);
      overflow:hidden;
    }

    .card .hd{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .card .hd .t{ font-weight:800; }
    .card .hd .d{ color:var(--muted); font-size:12px; margin-top:2px; }
    .card .bd{ padding:14px 16px; }

    .toolbar{
      max-width:1280px;
      margin:8px auto 0;
      padding:0 20px;
    }
    .banner{
      border:1px solid rgba(43,213,118,.25);
      background:rgba(43,213,118,.10);
      color:rgba(255,255,255,.90);
      border-radius:14px;
      padding:10px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .banner small{ color:rgba(255,255,255,.75); }
    .banner .right{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .banner .warn{
      border:1px solid rgba(255,204,0,.25);
      background:rgba(255,204,0,.10);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:rgba(255,255,255,.85);
    }

    .errBanner{
      max-width:1280px;
      margin:10px auto 0;
      padding:12px 16px;
      border-radius:14px;
      border:1px solid rgba(255,92,122,.35);
      background:rgba(255,92,122,.10);
      color:rgba(255,255,255,.90);
      display:none;
      white-space:pre-wrap;
    }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }

    label{ display:flex; flex-direction:column; gap:6px; font-size:12px; color:var(--muted); }
    input, select{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      outline:none;
      background:rgba(0,0,0,.25);
      color:var(--text);
    }

    .help{
      color:rgba(255,255,255,.65);
      font-size:12px;
      line-height:1.25;
      margin-top:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      border-radius:14px;
      padding:10px 12px;
    }
    .help b{ color:rgba(255,255,255,.92); }

    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    button{
      cursor:pointer;
      border:none;
      border-radius:12px;
      padding:10px 12px;
      font-weight:800;
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      color:white;
      box-shadow:0 12px 28px rgba(124,92,255,.25);
      transition:transform .08s ease, filter .2s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    button:hover{ filter:brightness(1.05); }
    button:active{ transform:translateY(1px); }
    button:disabled{ opacity:.55; cursor:not-allowed; filter:none; transform:none; }

    .ghost{
      background:rgba(255,255,255,.07);
      box-shadow:none;
      border:1px solid var(--border);
      color:var(--text);
      font-weight:750;
    }
    .danger{
      background:rgba(255,92,122,.12);
      border:1px solid rgba(255,92,122,.25);
      box-shadow:none;
    }

    .kpis{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:14px; }
    .kpi{
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      border-radius:16px;
      padding:12px;
    }
    .kpi .name{ color:var(--muted); font-size:12px; }
    .kpi .val{ font-size:18px; font-weight:900; margin-top:4px; }
    .kpi .hint{ color:var(--muted); font-size:12px; margin-top:4px; }

    .fuel-table{ width:100%; border-collapse:separate; border-spacing:0 10px; margin-top:10px; }
    .fuel-table th{
      text-align:left;
      color:var(--muted);
      font-weight:650;
      font-size:12px;
      padding:0 6px 6px;
    }
    .fuel-row{
      background:rgba(0,0,0,.18);
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
    }
    .fuel-table td{ padding:10px 6px; vertical-align:middle; }
    .fuel-table td:first-child{ padding-left:10px; }
    .fuel-table td:last-child{ padding-right:10px; }
    .rowbox{
      border:1px solid var(--border);
      background:rgba(0,0,0,.22);
      border-radius:12px;
      padding:8px 9px;
      width:100%;
    }

    .mini{ font-size:12px; color:var(--muted); }
    .hintbox{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      border-radius:14px;
      padding:10px 12px;
      margin-top:12px;
      color:var(--muted);
      font-size:12px;
    }

    .charts{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
    }
    .chartWrap{
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.18);
      border-radius:18px;
      overflow:hidden;
    }
    .chartWrap .chHd{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .chartWrap .chHd .ct{ font-weight:800; }
    .chartWrap .chHd .cd{ color:var(--muted); font-size:12px; margin-top:2px; }
    .chartWrap .chBd{ padding:10px 12px 12px; }
    .chart{ height:300px; width:100%; display:flex; align-items:center; justify-content:center; }
    .chartPlaceholder{
      border:1px dashed rgba(255,255,255,.18);
      border-radius:16px;
      padding:16px 14px;
      color:rgba(255,255,255,.75);
      text-align:center;
      width:100%;
    }
    .big{ grid-column:1 / span 2; }
    .big .chart{ height:320px; }

    .optBox{
      display:grid;
      grid-template-columns:1.2fr .8fr;
      gap:10px;
      margin-bottom:10px;
    }
    .optResults{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .optCard{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      border-radius:14px;
      padding:10px 12px;
    }
    .optCard .h{ color:var(--muted); font-size:12px; }
    .optCard .v{ font-weight:900; margin-top:4px; font-size:14px; }

    .rowActions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-top:12px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      color:rgba(255,255,255,.85);
    }

    @media (max-width:1060px){
      main{ grid-template-columns:1fr; }
      .charts{ grid-template-columns:1fr; }
      .big{ grid-column:auto; }
      .optBox{ grid-template-columns:1fr; }
    }
  </style>
</head>

<body>
<header>
  <div>
    <h1>CII Dashboard â€” Attained / Required / Rating</h1>
    <div class="sub">Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Attained/Required CII, rating Aâ€“E, charts ÎºÎ±Î¹ â€œwhat-ifâ€ fuel switch.</div>
  </div>
  <div class="pillrow">
    <div class="pill">ÎœÎ¿Î½Î¬Î´Î±: <strong>gCOâ‚‚ / (capacityÂ·nm)</strong></div>
    <div class="pill">Capacity: <strong>DWT Î® GT</strong></div>
    <div class="pill">Charts: <strong>ECharts</strong></div>
  </div>
</header>

<div class="toolbar">
  <div class="banner">
    <div>
      <b>Quick tips:</b> Î²Î¬Î»Îµ ÏƒÏ‰ÏƒÏ„Î¬ <b>annual distance</b> + <b>annual fuel</b> (Î¯Î´Î¹ÎµÏ‚ Ï‡ÏÎ¿Î½Î¹ÎºÎ­Ï‚ Î²Î¬ÏƒÎµÎ¹Ï‚).
      <small>Î— Î±Ï€ÏŒÏƒÏ„Î±ÏƒÎ· ÎµÏ€Î·ÏÎµÎ¬Î¶ÎµÎ¹ Ï„Î¿ denominator (capacityÂ·nm), Ï„Î¿ fuel Ï„Î¹Ï‚ ÎµÎºÏ€Î¿Î¼Ï€Î­Ï‚.</small>
    </div>
    <div class="right">
      <span id="chartsState" class="warn">Checking chartsâ€¦</span>
      <button id="pdfBtn" class="ghost" type="button" title="ÎšÎ±Ï„ÎµÎ²Î¬Î¶ÎµÎ¹ PDF report Î¼Îµ KPIs & charts" disabled>ğŸ“„ Download PDF</button>
    </div>
  </div>
</div>

<div id="errBanner" class="errBanner"></div>

<main>
  <!-- LEFT -->
  <section class="card" id="inputsCard">
    <div class="hd">
      <div>
        <div class="t">Î•Î¯ÏƒÎ¿Î´Î¿Î¹</div>
        <div class="d">Ship type, capacity, distance, fuel consumption</div>
      </div>
      <span class="badge" id="ratingBadge">â€”</span>
    </div>

    <div class="bd">
      <div class="grid2">
        <label>
          Ship type
          <select id="shipType">
            <option value="bulk">Bulk carrier (DWT)</option>
            <option value="tanker">Tanker (DWT)</option>
            <option value="container">Container ship (DWT)</option>
            <option value="gas_65p">Gas carrier â‰¥ 65,000 DWT (DWT)</option>
            <option value="gas_65m">Gas carrier &lt; 65,000 DWT (DWT)</option>
            <option value="general_20p">General cargo â‰¥ 20,000 DWT (DWT)</option>
            <option value="general_20m">General cargo &lt; 20,000 DWT (DWT)</option>
            <option value="refrig">Refrigerated cargo carrier (DWT)</option>
            <option value="combo">Combination carrier (DWT)</option>
            <option value="lng_100p">LNG carrier â‰¥ 100,000 DWT (DWT)</option>
            <option value="lng_100m">LNG carrier &lt; 100,000 DWT (DWT)</option>
            <option value="roro_vc">Ro-ro cargo (Vehicle Carrier) (GT)</option>
            <option value="roro_cargo">Ro-ro cargo ship (GT)</option>
            <option value="roro_pax">Ro-ro passenger ship (GT)</option>
            <option value="cruise">Cruise passenger ship (GT)</option>
            <option value="hsc">High-speed craft (GT)</option>
          </select>
        </label>

        <label>
          Reporting year
          <select id="year">
            <option>2023</option>
            <option selected>2024</option>
            <option>2025</option>
            <option>2026</option>
            <option>2027</option>
            <option>2028</option>
            <option>2029</option>
            <option>2030</option>
          </select>
        </label>
      </div>

      <div class="grid2" style="margin-top:12px;">
        <label>
          Capacity (DWT Î® GT)
          <input id="capacity" type="number" min="1" step="1" value="62000" />
        </label>
        <label>
          Annual distance travelled (nm)
          <input id="distance" type="number" min="1" step="1" value="60045" />
        </label>
      </div>

      <div class="grid2" style="margin-top:12px;">
        <label>
          Correction factor (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ) Ã—
          <input id="corr" type="number" min="0" step="0.01" value="1.00" />
        </label>
        <label>
          ÎœÎ¿Î½Î¬Î´Î± consumption
          <select id="fuelUnit">
            <option value="ton">tonnes (t)</option>
            <option value="kg" selected>kg</option>
          </select>
        </label>
      </div>

      <div class="help" id="sanityHelp">
        <b>Sanity check:</b>
        <span id="sanityText">â€”</span>
      </div>

      <div class="rowActions">
        <div>
          <div style="font-weight:850;">ÎšÎ±ÏÏƒÎ¹Î¼Î± & CF (tCOâ‚‚ / t fuel)</div>
          <div class="mini">Î”ÏÏƒÎµ annual consumption. Î¤Î¿ CF Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï„Î¿ Î±Î»Î»Î¬Î¾ÎµÎ¹Ï‚ Î±Î½ Î­Ï‡ÎµÎ¹Ï‚ ÎµÏ€Î¯ÏƒÎ·Î¼ÎµÏ‚ Ï„Î¹Î¼Î­Ï‚.</div>
        </div>
        <button class="ghost" id="addFuel" type="button">+ Fuel row</button>
      </div>

      <!-- STATIC default rows in HTML -->
      <table class="fuel-table">
        <thead>
          <tr>
            <th style="width:38%;">Fuel</th>
            <th style="width:28%;">Consumption</th>
            <th style="width:22%;">CF</th>
            <th style="width:12%;">&nbsp;</th>
          </tr>
        </thead>
        <tbody id="fuelBody">
          <tr class="fuel-row">
            <td><input class="rowbox fuel-name" value="HFO" /></td>
            <td><input class="rowbox fuel-cons" type="number" min="0" step="0.01" value="4200000" /></td>
            <td><input class="rowbox fuel-cf" type="number" min="0" step="0.001" value="3.114" /></td>
            <td style="text-align:right;"><button class="ghost del" type="button" style="padding:8px 10px;">âœ•</button></td>
          </tr>
          <tr class="fuel-row">
            <td><input class="rowbox fuel-name" value="MGO/MDO" /></td>
            <td><input class="rowbox fuel-cons" type="number" min="0" step="0.01" value="1300000" /></td>
            <td><input class="rowbox fuel-cf" type="number" min="0" step="0.001" value="3.206" /></td>
            <td style="text-align:right;"><button class="ghost del" type="button" style="padding:8px 10px;">âœ•</button></td>
          </tr>
          <tr class="fuel-row">
            <td><input class="rowbox fuel-name" value="LFO" /></td>
            <td><input class="rowbox fuel-cons" type="number" min="0" step="0.01" value="0" /></td>
            <td><input class="rowbox fuel-cf" type="number" min="0" step="0.001" value="3.151" /></td>
            <td style="text-align:right;"><button class="ghost del" type="button" style="padding:8px 10px;">âœ•</button></td>
          </tr>
        </tbody>
      </table>

      <div class="btnrow">
        <button id="calcBtn" type="button">ğŸ§® Î¥Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ</button>
        <button class="ghost" id="demoBtn" type="button">âœ¨ Demo</button>
        <button class="ghost" id="exportBtn" type="button">ğŸ–¼ï¸ Export charts PNG</button>
      </div>

      <div class="hintbox">
        Tip: Î‘Î½ Î¸ÎµÏ‚ â€œÎºÎ±Î¸Î±ÏÏŒâ€ Î±Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î± Ï‡Ï‰ÏÎ¯Ï‚ Î´Î¹Î¿ÏÎ¸ÏÏƒÎµÎ¹Ï‚, Î¬Ï†Î·ÏƒÎµ Correction factor = <b>1.00</b>.
        Î‘Î½ Ï„Î¿ annual distance ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Ï Î¼Î¹ÎºÏÏŒ, Ï„Î¿ Attained â€œÏ†Î¿Ï…ÏƒÎºÏÎ½ÎµÎ¹â€.
      </div>
    </div>
  </section>

  <!-- RIGHT -->
  <section class="card" id="resultsCard">
    <div class="hd">
      <div>
        <div class="t">Î‘Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î± & Î”Î¹Î±Î³ÏÎ¬Î¼Î¼Î±Ï„Î±</div>
        <div class="d">Gauge, COâ‚‚ breakdown, grade-vs-distance, optimizer, projection</div>
      </div>
      <div class="mini" id="lastRun">â€”</div>
    </div>

    <div class="bd">
      <div class="kpis">
        <div class="kpi">
          <div class="name">Total COâ‚‚ emissions</div>
          <div class="val" id="kpiCO2">â€”</div>
          <div class="hint">Î£ÏÎ½Î¿Î»Î¿ (tCOâ‚‚)</div>
        </div>
        <div class="kpi">
          <div class="name">Attained CII</div>
          <div class="val" id="kpiAtt">â€”</div>
          <div class="hint">gCOâ‚‚ / (capacityÂ·nm)</div>
        </div>
        <div class="kpi">
          <div class="name">Required CII</div>
          <div class="val" id="kpiReq">â€”</div>
          <div class="hint">Reference Ã— (1âˆ’Z)</div>
        </div>
        <div class="kpi">
          <div class="name">CII Rating</div>
          <div class="val" id="kpiRating">â€”</div>
          <div class="hint" id="kpiBand">â€”</div>
        </div>
      </div>

      <div class="charts">
        <div class="chartWrap">
          <div class="chHd">
            <div>
              <div class="ct">Rating Gauge</div>
              <div class="cd">Attained/Required + bands Aâ€“E</div>
            </div>
          </div>
          <div class="chBd">
            <div id="gauge" class="chart"><div class="chartPlaceholder">Charts disabled (ECharts not loaded)</div></div>
          </div>
        </div>

        <div class="chartWrap">
          <div class="chHd">
            <div>
              <div class="ct">COâ‚‚ Î±Î½Î¬ ÎºÎ±ÏÏƒÎ¹Î¼Î¿</div>
              <div class="cd">ÎŒÎ»Î± Ï„Î± fuels Ï€Î¿Ï… Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏƒÏ„Î¿Î½ Ï€Î¯Î½Î±ÎºÎ±</div>
            </div>
          </div>
          <div class="chBd">
            <div id="bar" class="chart"><div class="chartPlaceholder">Charts disabled (ECharts not loaded)</div></div>
          </div>
        </div>

        <div class="chartWrap">
          <div class="chHd">
            <div>
              <div class="ct">Grade vs Distance</div>
              <div class="cd">Î ÏŒÏ„Îµ Î±Î»Î»Î¬Î¶ÎµÎ¹ Ï„Î¿ grade Î±Î½ Î±Î»Î»Î¬Î¾ÎµÎ¹ Î· Î±Ï€ÏŒÏƒÏ„Î±ÏƒÎ·</div>
            </div>
          </div>
          <div class="chBd">
            <div id="gradeDist" class="chart"><div class="chartPlaceholder">Charts disabled (ECharts not loaded)</div></div>
          </div>
        </div>

        <div class="chartWrap">
          <div class="chHd">
            <div>
              <div class="ct">Fuel Switch Optimizer</div>
              <div class="cd">What-if Î±Î»Î»Î±Î³Î® Î¼Î¯Î³Î¼Î±Ï„Î¿Ï‚ + Î±Ï€Î»ÏŒ chart Î¼Î¯Î³Î¼Î±Ï„Î¿Ï‚ (%)</div>
            </div>
          </div>
          <div class="chBd">
            <div class="optBox">
              <label>
                Î£Ï„ÏŒÏ‡Î¿Ï‚ ÎºÎ±Ï…ÏƒÎ¯Î¼Î¿Ï…
                <select id="optTarget"></select>
              </label>
              <label>
                ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬ % Ï€ÏÎ¿Ï‚ ÏƒÏ„ÏŒÏ‡Î¿
                <input id="optPct" type="number" min="0" max="100" step="1" value="30" />
              </label>
            </div>

            <div class="mini" id="optTopSuggest">â€”</div>

            <div class="optResults">
              <div class="optCard"><div class="h">Current rating</div><div class="v" id="optCur">â€”</div></div>
              <div class="optCard"><div class="h">After switch rating</div><div class="v" id="optNew">â€”</div></div>
              <div class="optCard"><div class="h">Î” Attained CII</div><div class="v" id="optDelta">â€”</div></div>
              <div class="optCard"><div class="h">COâ‚‚ change</div><div class="v" id="optCO2">â€”</div></div>
            </div>

            <div style="margin-top:10px;">
              <!-- Simplified: 100% stacked mix chart (Current vs After) -->
              <div id="optMixChart" class="chart" style="height:240px;">
                <div class="chartPlaceholder">Charts disabled (ECharts not loaded)</div>
              </div>
            </div>

            <div class="help" style="margin-top:10px;">
              <b>Î ÏÏ‚ Ï€Î±Î¯ÏÎ½ÎµÎ¹ Ï„Î¿ %;</b> ÎœÎµÏ„Î±Ï†Î­ÏÎµÎ¹ Ï„Î¿ Î§% Ï„Î·Ï‚ ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ®Ï‚ ÎºÎ±Ï„Î±Î½Î¬Î»Ï‰ÏƒÎ·Ï‚ Î±Ï€ÏŒ Ï„Î± ÎºÎ±ÏÏƒÎ¹Î¼Î± Î¼Îµ Î¼ÎµÎ³Î±Î»ÏÏ„ÎµÏÎ¿ CF Ï€ÏÏÏ„Î±, Ï€ÏÎ¿Ï‚ Ï„Î¿ target.
            </div>
          </div>
        </div>

        <div class="chartWrap big">
          <div class="chHd">
            <div>
              <div class="ct">Projection Î±Ï…ÏƒÏ„Î·ÏÎ¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚</div>
              <div class="cd">Required CII Î±Î½Î¬ Î­Ï„Î¿Ï‚ vs ÏƒÏ„Î±Î¸ÎµÏÏŒ Attained</div>
            </div>
          </div>
          <div class="chBd">
            <div id="line" class="chart"><div class="chartPlaceholder">Charts disabled (ECharts not loaded)</div></div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
(() => {
  // ===== UI helpers =====
  const errBanner = document.getElementById("errBanner");
  const chartsState = document.getElementById("chartsState");
  const pdfBtn = document.getElementById("pdfBtn");
  const lastRun = document.getElementById("lastRun");
  const ratingBadge = document.getElementById("ratingBadge");
  const sanityText = document.getElementById("sanityText");

  function showErr(msg){
    errBanner.style.display = "block";
    errBanner.textContent = msg;
  }
  function hideErr(){
    errBanner.style.display = "none";
    errBanner.textContent = "";
  }

  // ===== Tables & factors (same functionality, kept) =====
  const REF = {
    bulk:        { piece: (cap)=>({a:4745, c:0.622, capAdj: Math.min(cap, 279000)}) },
    tanker:      { piece: (cap)=>({a:5247, c:0.610, capAdj: cap}) },
    container:   { piece: (cap)=>({a:1984, c:0.489, capAdj: cap}) },
    gas_65p:     { piece: (cap)=>({a:1.4405e11, c:2.071, capAdj: cap}) },
    gas_65m:     { piece: (cap)=>({a:8104, c:0.639, capAdj: cap}) },
    general_20p: { piece: (cap)=>({a:31948, c:0.792, capAdj: cap}) },
    general_20m: { piece: (cap)=>({a:588, c:0.3885, capAdj: cap}) },
    refrig:      { piece: (cap)=>({a:4600, c:0.557, capAdj: cap}) },
    combo:       { piece: (cap)=>({a:5119, c:0.622, capAdj: cap}) },
    lng_100p:    { piece: (_)=>({a:9.827, c:0.0, capAdj: 100000}) },
    lng_100m:    { piece: (cap)=>{
                    if (cap >= 65000) return {a:1.4479e14, c:2.673, capAdj: Math.min(cap, 100000)};
                    return {a:1.4479e14, c:2.673, capAdj: 65000};
                  }},
    roro_vc:     { piece: (cap)=>{
                    if (cap >= 57700) return {a:3627, c:0.590, capAdj: 57700};
                    if (cap >= 30000) return {a:3627, c:0.590, capAdj: cap};
                    return {a:330, c:0.329, capAdj: cap};
                  }},
    roro_cargo:  { piece: (cap)=>({a:1967, c:0.485, capAdj: cap}) },
    roro_pax:    { piece: (cap)=>({a:2023, c:0.460, capAdj: cap}) },
    cruise:      { piece: (cap)=>({a:930,  c:0.3839, capAdj: cap}) },
    hsc:         { piece: (cap)=>({a:4196, c:0.460, capAdj: cap}) },
  };

  const DD = {
    bulk:{d1:0.86,d2:0.94,d3:1.06,d4:1.18},
    tanker:{d1:0.82,d2:0.93,d3:1.08,d4:1.28},
    container:{d1:0.83,d2:0.94,d3:1.07,d4:1.19},
    gas_65p:{d1:0.81,d2:0.91,d3:1.12,d4:1.44},
    gas_65m:{d1:0.85,d2:0.95,d3:1.06,d4:1.25},
    general_20p:{d1:0.83,d2:0.94,d3:1.06,d4:1.19},
    general_20m:{d1:0.83,d2:0.94,d3:1.06,d4:1.19},
    refrig:{d1:0.78,d2:0.91,d3:1.07,d4:1.20},
    combo:{d1:0.87,d2:0.96,d3:1.06,d4:1.14},
    lng_100p:{d1:0.89,d2:0.98,d3:1.06,d4:1.13},
    lng_100m:{d1:0.78,d2:0.92,d3:1.10,d4:1.37},
    roro_vc:{d1:0.86,d2:0.94,d3:1.06,d4:1.16},
    roro_cargo:{d1:0.76,d2:0.89,d3:1.08,d4:1.27},
    roro_pax:{d1:0.76,d2:0.92,d3:1.14,d4:1.30},
    cruise:{d1:0.87,d2:0.95,d3:1.06,d4:1.16},
    hsc:{d1:0.87,d2:0.95,d3:1.06,d4:1.16},
  };

  function Z(y){
    y = Number(y);
    if (y===2023) return 5;
    if (y===2024) return 7;
    if (y===2025) return 9;
    if (y===2026) return 11;
    if (y>=2027 && y<=2030) return 5 + 2*(y-2023);
    return 11;
  }

  const ALT_LIBRARY = [
    { name:"LNG (indicative)", cf:2.75 },
    { name:"Biofuel blend (indicative)", cf:2.40 },
    { name:"Methanol (indicative)", cf:1.90 },
    { name:"Ammonia (indicative)", cf:0.60 },
    { name:"Hydrogen (indicative)", cf:0.00 },
  ];

  // ===== Formatting =====
  const css = getComputedStyle(document.documentElement);
  const COLORS = {
    A: css.getPropertyValue("--good").trim(),
    B: css.getPropertyValue("--good2").trim(),
    C: css.getPropertyValue("--warn").trim(),
    D: css.getPropertyValue("--bad2").trim(),
    E: css.getPropertyValue("--bad").trim(),
  };
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
  const roundTo = (n,d=2)=>{ const p=10**d; return Math.round(n*p)/p; };
  const fmt = (n,d=3)=> Number.isFinite(n) ? n.toLocaleString("el-GR",{maximumFractionDigits:d, minimumFractionDigits:d}) : "â€”";
  const fmt0 = (n)=> Number.isFinite(n) ? n.toLocaleString("el-GR",{maximumFractionDigits:0}) : "â€”";
  const ratingColor = (r)=> COLORS[r] ?? COLORS.E;
  const ratingToNum = (r)=> ({A:1,B:2,C:3,D:4,E:5})[r] ?? 5;
  const numToRating = (n)=> ({1:"A",2:"B",3:"C",4:"D",5:"E"})[n] ?? "E";

  // ===== DOM =====
  const els = {
    shipType: document.getElementById("shipType"),
    year: document.getElementById("year"),
    capacity: document.getElementById("capacity"),
    distance: document.getElementById("distance"),
    corr: document.getElementById("corr"),
    fuelUnit: document.getElementById("fuelUnit"),
    fuelBody: document.getElementById("fuelBody"),
    addFuel: document.getElementById("addFuel"),
    calcBtn: document.getElementById("calcBtn"),
    demoBtn: document.getElementById("demoBtn"),
    exportBtn: document.getElementById("exportBtn"),

    kpiCO2: document.getElementById("kpiCO2"),
    kpiAtt: document.getElementById("kpiAtt"),
    kpiReq: document.getElementById("kpiReq"),
    kpiRating: document.getElementById("kpiRating"),
    kpiBand: document.getElementById("kpiBand"),

    optTarget: document.getElementById("optTarget"),
    optPct: document.getElementById("optPct"),
    optTopSuggest: document.getElementById("optTopSuggest"),
    optCur: document.getElementById("optCur"),
    optNew: document.getElementById("optNew"),
    optDelta: document.getElementById("optDelta"),
    optCO2: document.getElementById("optCO2"),
  };

  function wireRow(tr){
    const del = tr.querySelector(".del");
    if (del) del.addEventListener("click", ()=>{ tr.remove(); refreshOptTargets(); run(); });
    tr.querySelectorAll("input").forEach(inp => inp.addEventListener("input", ()=>{ refreshOptTargets(); run(); }));
  }
  [...els.fuelBody.querySelectorAll("tr")].forEach(wireRow);

  function newRow(name="New fuel", cons=0, cf=3.114){
    const tr = document.createElement("tr");
    tr.className = "fuel-row";
    tr.innerHTML = `
      <td><input class="rowbox fuel-name" value="${String(name).replaceAll('"','&quot;')}" /></td>
      <td><input class="rowbox fuel-cons" type="number" min="0" step="0.01" value="${cons}" /></td>
      <td><input class="rowbox fuel-cf" type="number" min="0" step="0.001" value="${cf}" /></td>
      <td style="text-align:right;"><button class="ghost del" type="button" style="padding:8px 10px;">âœ•</button></td>
    `;
    wireRow(tr);
    return tr;
  }

  function getFuels(){
    return [...els.fuelBody.querySelectorAll("tr")].map(r => ({
      name: (r.querySelector(".fuel-name")?.value || "").trim() || "Fuel",
      cons: Number(r.querySelector(".fuel-cons")?.value || 0),
      cf: Number(r.querySelector(".fuel-cf")?.value || 0),
    }));
  }

  function consToTon(cons, unit){ return unit==="kg" ? cons/1000 : cons; }

  function totalCO2t(fuels, unit){
    let co2=0;
    for (const f of fuels){
      const t = consToTon(f.cons, unit);
      if (t>0 && f.cf>0) co2 += t*f.cf;
    }
    return co2;
  }

  function totalTonnes(fuels, unit){
    return fuels.reduce((s,f)=> s + Math.max(0, consToTon(f.cons, unit)), 0);
  }

  function attainedCII(co2_t, cap, dist, corr){
    const co2_g = co2_t * 1_000_000;
    return (co2_g/(cap*dist))*corr;
  }

  function requiredCII(shipType, cap, year){
    const {a,c,capAdj} = REF[shipType].piece(cap);
    const cii_ref = a * Math.pow(capAdj, -c);
    return { cii_ref, required: cii_ref*(100-Z(year))/100 };
  }

  function rating(shipType, attained, required){
    const ratio = attained/required;
    const {d1,d2,d3,d4} = DD[shipType];
    let r="E";
    if (ratio<d1) r="A";
    else if (ratio<d2) r="B";
    else if (ratio<d3) r="C";
    else if (ratio<d4) r="D";
    return {r, ratio, dd:{d1,d2,d3,d4}};
  }

  // ===== Charts =====
  const chartsEnabled = typeof window.echarts !== "undefined";
  chartsState.textContent = chartsEnabled ? "Charts: OK" : "Charts: blocked";
  chartsState.style.borderColor = chartsEnabled ? "rgba(43,213,118,.25)" : "rgba(255,92,122,.35)";
  chartsState.style.background = chartsEnabled ? "rgba(43,213,118,.10)" : "rgba(255,92,122,.10)";
  chartsState.style.color = "rgba(255,255,255,.85)";
  pdfBtn.disabled = !chartsEnabled; // PDF uses chart screenshots (still can make text-only, but user asked easy)

  let gaugeChart, barChart, gradeDistChart, optMixChart, lineChart;

  function ensureCharts(){
    if (!chartsEnabled) return;
    if (gaugeChart) return;

    gaugeChart = echarts.init(document.getElementById("gauge"));
    barChart = echarts.init(document.getElementById("bar"));
    gradeDistChart = echarts.init(document.getElementById("gradeDist"));
    optMixChart = echarts.init(document.getElementById("optMixChart"));
    lineChart = echarts.init(document.getElementById("line"));

    window.addEventListener("resize", ()=>{
      gaugeChart.resize(); barChart.resize(); gradeDistChart.resize(); optMixChart.resize(); lineChart.resize();
    });
  }

  function renderGauge(ratio, r, dd){
    if (!chartsEnabled) return;
    ensureCharts();
    const maxRatio = Math.max(1.6, dd.d4*1.15);
    const segs = [
      [dd.d1/maxRatio, ratingColor("A")],
      [dd.d2/maxRatio, ratingColor("B")],
      [dd.d3/maxRatio, ratingColor("C")],
      [dd.d4/maxRatio, ratingColor("D")],
      [1, ratingColor("E")]
    ].map(([p,c])=>[clamp(p,0,1), c]);

    gaugeChart.setOption({
      backgroundColor:"transparent",
      tooltip:{ formatter:(p)=> `Att/Req: <b>${fmt(p.value,3)}</b><br/>Rating: <b>${r}</b>` },
      series:[{
        type:"gauge",
        min:0, max:maxRatio, splitNumber:6,
        axisLine:{ lineStyle:{ width:16, color:segs } },
        pointer:{ length:"62%", width:6 },
        axisLabel:{ distance:18, color:"rgba(255,255,255,.75)", formatter:(v)=> String(roundTo(v,2)) },
        detail:{ valueAnimation:true, fontSize:26, offsetCenter:[0,"20%"], color:"rgba(255,255,255,.92)", formatter:(v)=> fmt(v,3) },
        data:[{ value: ratio, name:"Attained / Required" }]
      }]
    });
  }

  function renderBar(fuels, unit){
    if (!chartsEnabled) return;
    ensureCharts();
    const names = fuels.map(f=>f.name);
    const values = fuels.map(f=>{
      const t = consToTon(f.cons, unit);
      const co2 = (t>0 && f.cf>0) ? t*f.cf : 0;
      return Number(co2.toFixed(3));
    });

    barChart.setOption({
      backgroundColor:"transparent",
      tooltip:{ trigger:"axis", axisPointer:{type:"shadow"} },
      grid:{ left:54, right:18, top:18, bottom:56 },
      xAxis:{ type:"category", data:names, axisLabel:{ color:"rgba(255,255,255,.75)", rotate:22, interval:0 },
              axisLine:{ lineStyle:{ color:"rgba(255,255,255,.18)" } } },
      yAxis:{ type:"value", axisLabel:{ color:"rgba(255,255,255,.75)" },
              splitLine:{ lineStyle:{ color:"rgba(255,255,255,.10)" } } },
      series:[{ type:"bar", data:values, barWidth:"55%", itemStyle:{ borderRadius:[10,10,6,6] }, barMinHeight:2 }]
    });
  }

  // Keep your grade chart (discrete Aâ€“E) but make x axis numeric for better reading
  function renderGradeVsDistance(shipType, cap, corr, fuels, unit, required){
    if (!chartsEnabled) return;
    ensureCharts();

    const baseDist = Number(els.distance.value);
    const co2_t = totalCO2t(fuels, unit);

    const pts=[];
    for(let i=0;i<=24;i++){
      const factor = 0.5 + i*(1/24);
      const dist = baseDist*factor;
      const att = attainedCII(co2_t, cap, dist, corr);
      const rr = rating(shipType, att, required);
      pts.push({dist, gradeNum:ratingToNum(rr.r), r:rr.r, ratio:rr.ratio});
    }

    gradeDistChart.setOption({
      backgroundColor:"transparent",
      tooltip:{
        trigger:"axis",
        formatter:(ps)=>{
          const x = Number(ps[0].axisValue);
          const p = pts.reduce((best,cur)=> Math.abs(cur.dist-x)<Math.abs(best.dist-x) ? cur : best, pts[0]);
          return `Distance: <b>${fmt0(x)} nm</b><br/>Rating: <b>${p.r}</b><br/>Att/Req: ${fmt(p.ratio,3)}`;
        }
      },
      grid:{ left:70, right:18, top:18, bottom:44 },
      xAxis:{
        type:"value",
        axisLabel:{ color:"rgba(255,255,255,.75)" },
        splitLine:{ lineStyle:{ color:"rgba(255,255,255,.10)" } },
        axisLine:{ lineStyle:{ color:"rgba(255,255,255,.18)" } }
      },
      yAxis:{
        type:"value", min:1, max:5, interval:1, inverse:true,
        axisLabel:{ color:"rgba(255,255,255,.75)", formatter:(v)=>numToRating(v) },
        splitLine:{ lineStyle:{ color:"rgba(255,255,255,.10)" } },
        axisLine:{ lineStyle:{ color:"rgba(255,255,255,.18)" } }
      },
      series:[{
        name:"Grade",
        type:"line",
        step:"middle",
        data: pts.map(p=> [p.dist, p.gradeNum]),
        symbolSize:6,
        lineStyle:{ width:3 },
        areaStyle:{ opacity:0.06 }
      }]
    });
  }

  function renderProjection(cii_ref, attained){
    if (!chartsEnabled) return;
    ensureCharts();
    const years=[2023,2024,2025,2026,2027,2028,2029,2030];
    const reqSeries = years.map(y=> Number((cii_ref*(100-Z(y))/100).toFixed(4)));
    const attSeries = years.map(()=> Number(attained.toFixed(4)));

    lineChart.setOption({
      backgroundColor:"transparent",
      tooltip:{ trigger:"axis" },
      legend:{ top:10, textStyle:{ color:"rgba(255,255,255,.75)" } },
      grid:{ left:54, right:18, top:44, bottom:40 },
      xAxis:{ type:"category", data:years, axisLabel:{ color:"rgba(255,255,255,.75)" },
              axisLine:{ lineStyle:{ color:"rgba(255,255,255,.18)" } } },
      yAxis:{ type:"value", axisLabel:{ color:"rgba(255,255,255,.75)" },
              splitLine:{ lineStyle:{ color:"rgba(255,255,255,.10)" } } },
      series:[
        { name:"Required CII", type:"line", smooth:true, data:reqSeries, symbolSize:7, lineStyle:{ width:3 } },
        { name:"Attained CII (ÏƒÏ„Î±Î¸ÎµÏÏŒ)", type:"line", smooth:true, data:attSeries, symbolSize:7, lineStyle:{ width:2, type:"dashed" } },
      ]
    });
  }

  // ===== Optimizer =====
  function buildTargets(fuels){
    const seen=new Set();
    const t=[];
    for (const f of fuels){
      const name=(f.name||"").trim();
      if (!name) continue;
      const key=name.toLowerCase();
      if (seen.has(key)) continue;
      if (!Number.isFinite(f.cf) || f.cf<=0) continue;
      seen.add(key);
      t.push({name, cf:f.cf});
    }
    return t.sort((a,b)=>a.name.localeCompare(b.name));
  }

  function refreshOptTargets(){
    const fuels = getFuels();
    const merged = fuels.concat(ALT_LIBRARY.map(x=>({name:x.name, cons:0, cf:x.cf})));
    const targets = buildTargets(merged);
    const prev = els.optTarget.value;

    els.optTarget.innerHTML = "";
    for (const t of targets){
      const o=document.createElement("option");
      o.value=t.name;
      o.textContent=`${t.name} (CF ${roundTo(t.cf,3)})`;
      els.optTarget.appendChild(o);
    }
    if (prev && targets.some(x=>x.name===prev)) els.optTarget.value=prev;

    const best = targets.slice().sort((a,b)=>a.cf-b.cf).slice(0,3);
    els.optTopSuggest.textContent = best.length
      ? `Î•Î½Î±Î»Î»Î±ÎºÏ„Î¹ÎºÎ­Ï‚ Ï‡Î±Î¼Î·Î»ÏŒÏ„ÎµÏÎ¿Ï… CF: ` + best.map(b=>`${b.name} (CF ${roundTo(b.cf,3)})`).join(" â€¢ ")
      : "â€”";
  }

  function optimizerScenario(fuels, unit, targetName, pct){
    const p = clamp(Number(pct)/100, 0, 1);
    const out = fuels.map(f=>({...f}));

    let targetIdx = out.findIndex(f => (f.name||"").trim()===targetName);
    if (targetIdx < 0){
      const lib = ALT_LIBRARY.find(x=>x.name===targetName);
      if (!lib) return {ok:false};
      out.push({name:lib.name, cons:0, cf:lib.cf});
      targetIdx = out.length - 1;
    }

    const totalT = totalTonnes(out, unit);
    if (totalT <= 0) return {ok:false};

    let moveT = totalT * p;

    const donors = out.map((f,i)=>({i, cf:f.cf, t:Math.max(0, consToTon(f.cons, unit))}))
      .filter(x=>x.t>0 && Number.isFinite(x.cf) && x.cf>0)
      .sort((a,b)=>b.cf-a.cf);

    const movedFrom = []; // for user-friendly explanation

    for (const d of donors){
      if (d.i === targetIdx) continue;
      if (moveT <= 0) break;

      const take = Math.min(d.t, moveT);

      const donorNewT = d.t - take;
      out[d.i].cons = (unit==="kg") ? donorNewT*1000 : donorNewT;

      const tgtT = Math.max(0, consToTon(out[targetIdx].cons, unit));
      const tgtNewT = tgtT + take;
      out[targetIdx].cons = (unit==="kg") ? tgtNewT*1000 : tgtNewT;

      movedFrom.push({name: out[d.i].name, t: take});
      moveT -= take;
    }

    return {ok:true, fuels:out, movedFrom};
  }

  // Simplified optimizer chart: 100% stacked mix (% consumption)
  function renderOptMixChart(currentFuels, afterFuels, unit){
    if (!chartsEnabled) return;
    ensureCharts();

    const toMap = (arr) => {
      const m = new Map();
      for (const f of arr){
        const t = Math.max(0, consToTon(f.cons, unit));
        if (!m.has(f.name)) m.set(f.name, 0);
        m.set(f.name, m.get(f.name) + t);
      }
      return m;
    };

    const curMap = toMap(currentFuels);
    const aftMap = toMap(afterFuels);

    const allNames = Array.from(new Set([...curMap.keys(), ...aftMap.keys()]))
      .filter(n=>n && n.trim().length)
      .sort((a,b)=>a.localeCompare(b));

    const curTotal = Array.from(curMap.values()).reduce((a,b)=>a+b,0) || 1;
    const aftTotal = Array.from(aftMap.values()).reduce((a,b)=>a+b,0) || 1;

    const series = allNames.map((name) => {
      const curPct = ( (curMap.get(name)||0) / curTotal ) * 100;
      const aftPct = ( (aftMap.get(name)||0) / aftTotal ) * 100;
      return {
        name,
        type:"bar",
        stack:"mix",
        emphasis:{ focus:"series" },
        data: [ Number(curPct.toFixed(2)), Number(aftPct.toFixed(2)) ],
        barWidth:18
      };
    });

    optMixChart.setOption({
      backgroundColor:"transparent",
      tooltip:{
        trigger:"axis",
        axisPointer:{ type:"shadow" },
        formatter:(ps)=>{
          const label = ps[0].axisValue;
          const lines = ps
            .filter(p=>p.data>0.01)
            .sort((a,b)=>b.data-a.data)
            .slice(0,8)
            .map(p=>`${p.marker} ${p.seriesName}: <b>${fmt(p.data,2)}%</b>`);
          return `<b>${label}</b><br/>` + (lines.length?lines.join("<br/>"):"(no consumption)");
        }
      },
      legend:{
        type:"scroll",
        top:0,
        textStyle:{ color:"rgba(255,255,255,.75)" }
      },
      grid:{ left:40, right:20, top:44, bottom:28 },
      xAxis:{
        type:"value",
        max:100,
        axisLabel:{ color:"rgba(255,255,255,.75)", formatter:(v)=> v + "%" },
        splitLine:{ lineStyle:{ color:"rgba(255,255,255,.10)" } },
        axisLine:{ lineStyle:{ color:"rgba(255,255,255,.18)" } }
      },
      yAxis:{
        type:"category",
        data:["Current mix","After switch"],
        axisLabel:{ color:"rgba(255,255,255,.80)" },
        axisLine:{ lineStyle:{ color:"rgba(255,255,255,.18)" } }
      },
      series
    });
  }

  // ===== Sanity hints (user friendly) =====
  function sanityMessage(shipType, distanceNm){
    // not strict, just helpful ranges
    const d = Number(distanceNm);
    if (!Number.isFinite(d) || d<=0) return "Î”ÏÏƒÎµ annual distance (nm).";

    const typeHints = {
      bulk: "Bulk ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ ~35,000â€“70,000 nm/yr.",
      tanker: "Tanker ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ ~55,000â€“85,000 nm/yr (ÎµÎºÏ„ÏŒÏ‚ Î±Î½ ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Ï low utilization).",
      container: "Container liner ÏƒÏ…Ï‡Î½Î¬ ~70,000â€“100,000+ nm/yr.",
      gas_65p: "Gas carriers ÏƒÏ…Ï‡Î½Î¬ ~50,000â€“90,000 nm/yr.",
      gas_65m: "Gas carriers ÏƒÏ…Ï‡Î½Î¬ ~50,000â€“80,000 nm/yr.",
      general_20p: "General cargo ÏƒÏ…Ï‡Î½Î¬ ~35,000â€“60,000 nm/yr.",
      general_20m: "General cargo ÏƒÏ…Ï‡Î½Î¬ ~30,000â€“55,000 nm/yr.",
      refrig: "Reefer ÏƒÏ…Ï‡Î½Î¬ ~40,000â€“70,000 nm/yr.",
      combo: "Combination carriers ÏƒÏ…Ï‡Î½Î¬ ~40,000â€“70,000 nm/yr.",
      lng_100p: "LNG ÏƒÏ…Ï‡Î½Î¬ ~60,000â€“90,000 nm/yr.",
      lng_100m: "LNG ÏƒÏ…Ï‡Î½Î¬ ~60,000â€“90,000 nm/yr.",
      roro_vc: "Vehicle carriers ~65,000â€“85,000 nm/yr.",
      roro_cargo: "Ro-ro cargo ~55,000â€“75,000 nm/yr.",
      roro_pax: "Ro-ro pax varies, Î±Î»Î»Î¬ ÏƒÏ…Ï‡Î½Î¬ 50,000+ nm/yr.",
      cruise: "Cruise varies, ÏƒÏ…Ï‡Î½Î¬ 40,000â€“70,000 nm/yr.",
      hsc: "HSC varies a lot."
    };

    const hint = typeHints[shipType] || "Î”ÏÏƒÎµ ÏÎµÎ±Î»Î¹ÏƒÏ„Î¹ÎºÏŒ annual distance.";
    if (d < 15000) return `âš ï¸ Î Î¿Î»Ï Ï‡Î±Î¼Î·Î»ÏŒ annual distance (${fmt0(d)} nm). Î‘Ï…Ï„ÏŒ ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ â€œÏ†Î¿Ï…ÏƒÎºÏÎ½ÎµÎ¹â€ Ï„Î¿ Attained CII. ${hint}`;
    if (d > 120000) return `â„¹ï¸ Î Î¿Î»Ï Ï…ÏˆÎ·Î»ÏŒ annual distance (${fmt0(d)} nm). ÎˆÎ»ÎµÎ³Î¾Îµ Î±Î½ ÎµÎ¯Î½Î±Î¹ annual. ${hint}`;
    return `âœ… ${hint}`;
  }

  // ===== PDF Report =====
  async function downloadPDFReport(state){
    try{
      if (!chartsEnabled) {
        alert("Charts blocked. Î”ÎµÎ½ Î¼Ï€Î¿ÏÏ Î½Î± Î²Î³Î¬Î»Ï‰ PDF Î¼Îµ charts. (Î†Î½Î¿Î¹Î¾Îµ/ÎµÏ€Î¯Ï„ÏÎµÏˆÎµ Ï„Î¿ echarts CDN Î® Î²Î¬Î»Îµ local.)");
        return;
      }
      ensureCharts();

      // jsPDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation:"p", unit:"mm", format:"a4" });

      const margin = 10;
      let y = 12;

      // Header
      doc.setFont("helvetica", "bold");
      doc.setFontSize(14);
      doc.text("CII Report â€” Attained / Required / Rating", margin, y);
      y += 7;

      doc.setFont("helvetica", "normal");
      doc.setFontSize(10);
      const meta = [
        `Ship type: ${state.shipTypeLabel}`,
        `Year: ${state.year}`,
        `Capacity: ${fmt0(state.cap)} (${state.capType})`,
        `Annual distance: ${fmt0(state.dist)} nm`,
        `Consumption unit: ${state.unit}`,
        `Correction factor: ${state.corr}`
      ];
      meta.forEach(line => { doc.text(line, margin, y); y += 5; });
      y += 2;

      // KPIs block
      doc.setFont("helvetica", "bold");
      doc.text("KPIs", margin, y);
      y += 6;

      doc.setFont("helvetica", "normal");
      const kpis = [
        `Total CO2: ${fmt0(state.co2_t)} tCO2`,
        `Attained CII: ${fmt(state.att,3)} gCO2/(capacityÂ·nm)`,
        `Required CII: ${fmt(state.req.required,3)} gCO2/(capacityÂ·nm)`,
        `Rating: ${state.rr.r} (Att/Req ${fmt(state.rr.ratio,3)})`
      ];
      kpis.forEach(line => { doc.text(line, margin, y); y += 5; });
      y += 2;

      // Fuel table (top 8 rows)
      doc.setFont("helvetica","bold");
      doc.text("Fuel inputs (top rows)", margin, y);
      y += 6;
      doc.setFont("helvetica","normal");

      const fuels = state.fuels.slice(0,8);
      fuels.forEach((f, idx)=>{
        const t = consToTon(f.cons, state.unit);
        doc.text(`${idx+1}. ${f.name} â€” cons: ${fmt0(f.cons)} (${state.unit}) | CF: ${f.cf} | CO2: ${fmt(t*f.cf,1)} t`, margin, y);
        y += 5;
      });
      y += 2;

      // Charts images
      const addChart = (title, chart, w=190, h=55) => {
        const img = chart.getDataURL({ type:"png", pixelRatio:2, backgroundColor:"#0b1020" });
        if (y + h + 10 > 287) { doc.addPage(); y = 12; }
        doc.setFont("helvetica","bold");
        doc.text(title, margin, y);
        y += 4;
        doc.addImage(img, "PNG", margin, y, w, h);
        y += h + 8;
      };

      addChart("Rating Gauge", gaugeChart, 190, 55);
      addChart("CO2 by fuel", barChart, 190, 55);
      addChart("Grade vs Distance", gradeDistChart, 190, 55);
      addChart("Fuel mix % (Current vs After)", optMixChart, 190, 60);
      addChart("Projection: Required vs Attained", lineChart, 190, 55);

      doc.save(`CII_Report_${state.shipType}_${state.year}.pdf`);
    } catch(e){
      console.error(e);
      alert("PDF generation failed. Î†Î½Î¿Î¹Î¾Îµ Console (F12) Î³Î¹Î± Î»ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚.");
    }
  }

  // ===== Run & compute =====
  let lastState = null;

  function run(){
    try{
      hideErr();
      ensureCharts();

      const shipType = els.shipType.value;
      const year = Number(els.year.value);
      const cap  = Number(els.capacity.value);
      const dist = Number(els.distance.value);
      const corr = clamp(Number(els.corr.value || 1), 0, 10);
      const unit = els.fuelUnit.value;

      if (!REF[shipType] || !DD[shipType]) throw new Error("Unknown ship type tables.");
      if (!Number.isFinite(cap) || cap<=0) throw new Error("Capacity must be > 0.");
      if (!Number.isFinite(dist) || dist<=0) throw new Error("Distance must be > 0.");

      const fuels = getFuels();

      // user-friendly sanity text
      sanityText.textContent = sanityMessage(shipType, dist);

      const co2_t = totalCO2t(fuels, unit);
      const att   = attainedCII(co2_t, cap, dist, corr);
      const req   = requiredCII(shipType, cap, year);
      const rr    = rating(shipType, att, req.required);

      // capacity type label
      const capType = (shipType.startsWith("roro") || shipType==="cruise" || shipType==="hsc") ? "GT" : "DWT";
      const shipTypeLabel = els.shipType.options[els.shipType.selectedIndex]?.textContent || shipType;

      // KPIs
      els.kpiCO2.textContent = `${fmt0(co2_t)} tCOâ‚‚`;
      els.kpiAtt.textContent = fmt(att,3);
      els.kpiReq.textContent = fmt(req.required,3);
      els.kpiRating.textContent = rr.r;
      els.kpiRating.style.color = ratingColor(rr.r);
      els.kpiBand.textContent = `Att/Req = ${fmt(rr.ratio,3)}`;

      ratingBadge.textContent = `Rating: ${rr.r} â€¢ Att/Req ${fmt(rr.ratio,3)}`;
      ratingBadge.style.borderColor = "rgba(255,255,255,.12)";
      ratingBadge.style.background = `linear-gradient(90deg, ${ratingColor(rr.r)}22, rgba(255,255,255,.05))`;

      lastRun.textContent = `Updated: ${new Date().toLocaleString("el-GR")}`;

      // Charts
      renderGauge(rr.ratio, rr.r, rr.dd);
      renderBar(fuels, unit);
      renderGradeVsDistance(shipType, cap, corr, fuels, unit, req.required);
      renderProjection(req.cii_ref, att);

      // Optimizer
      refreshOptTargets();
      const target = els.optTarget.value || "";
      const pct = Number(els.optPct.value || 0);

      const scen = optimizerScenario(fuels, unit, target, pct);
      if (!scen.ok){
        els.optCur.textContent = rr.r;
        els.optCur.style.color = ratingColor(rr.r);
        els.optNew.textContent = "â€”";
        els.optDelta.textContent = "â€”";
        els.optCO2.textContent = "â€”";
        // mix chart current=after
        renderOptMixChart(fuels, fuels, unit);
      } else {
        const newCO2 = totalCO2t(scen.fuels, unit);
        const newAtt = attainedCII(newCO2, cap, dist, corr);
        const newRR  = rating(shipType, newAtt, req.required);

        els.optCur.textContent = `${rr.r} (Att/Req ${fmt(rr.ratio,2)})`;
        els.optCur.style.color = ratingColor(rr.r);

        els.optNew.textContent = `${newRR.r} (Att/Req ${fmt(newRR.ratio,2)})`;
        els.optNew.style.color = ratingColor(newRR.r);

        els.optDelta.textContent = `${(newAtt-att)>=0?"+":""}${fmt(newAtt-att,3)}`;
        els.optCO2.textContent = `${(newCO2-co2_t)>=0?"+":""}${fmt(newCO2-co2_t,1)} tCOâ‚‚`;

        // simplified % chart
        renderOptMixChart(fuels, scen.fuels, unit);
      }

      // store state for PDF
      lastState = {
        shipType,
        shipTypeLabel,
        year,
        cap,
        capType,
        dist,
        corr,
        unit,
        fuels: fuels.map(f=>({...f})),
        co2_t,
        att,
        req,
        rr
      };

      // enable pdf when we have a state and jsPDF exists
      const pdfOK = !!(window.jspdf && window.jspdf.jsPDF) && chartsEnabled;
      pdfBtn.disabled = !pdfOK;

    } catch(e){
      showErr("JS Error:\n" + (e && e.message ? e.message : String(e)) + "\n\nÎ†Î½Î¿Î¹Î¾Îµ F12 â†’ Console Î³Î¹Î± Î»ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚.");
      console.error(e);
    }
  }

  // ===== Events =====
  ["shipType","year","capacity","distance","corr","fuelUnit"].forEach(id=>{
    document.getElementById(id).addEventListener("input", run);
    document.getElementById(id).addEventListener("change", run);
  });

  els.addFuel.addEventListener("click", ()=>{
    els.fuelBody.appendChild(newRow());
    refreshOptTargets();
    run();
  });

  els.calcBtn.addEventListener("click", run);

  els.demoBtn.addEventListener("click", ()=>{
    els.shipType.value="bulk";
    els.year.value="2026";
    els.capacity.value=62000;
    els.distance.value=60045;
    els.corr.value=1.00;
    els.fuelUnit.value="ton";

    els.fuelBody.innerHTML = "";
    els.fuelBody.appendChild(newRow("HFO", 4200, 3.114));
    els.fuelBody.appendChild(newRow("MGO/MDO", 1300, 3.206));
    els.fuelBody.appendChild(newRow("LFO", 0, 3.151));

    refreshOptTargets();
    run();
  });

  els.optTarget.addEventListener("change", run);
  els.optPct.addEventListener("input", run);

  els.exportBtn.addEventListener("click", ()=>{
    if (!chartsEnabled || !window.echarts){
      alert("ECharts Î´ÎµÎ½ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ, Î¬ÏÎ± Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ export PNG.");
      return;
    }
    ensureCharts();
    const a=document.createElement("a");
    const bg="#0b1020";
    const list=[
      ["cii_gauge.png", gaugeChart],
      ["cii_co2_by_fuel.png", barChart],
      ["cii_grade_vs_distance.png", gradeDistChart],
      ["cii_fuel_mix_percent.png", optMixChart],
      ["cii_projection.png", lineChart],
    ];
    for (const [name,ch] of list){
      const url = ch.getDataURL({type:"png", pixelRatio:2, backgroundColor:bg});
      a.href=url; a.download=name; a.click();
    }
  });

  pdfBtn.addEventListener("click", async ()=>{
    if (!lastState) return;
    await downloadPDFReport(lastState);
  });

  // ===== Init =====
  refreshOptTargets();
  [...els.fuelBody.querySelectorAll("tr")].forEach(wireRow);
  run();

})();
</script>
</body>
</html>
